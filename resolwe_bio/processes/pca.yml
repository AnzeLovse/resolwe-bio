# ===
# PCA
# ===
---

- name: pca:1-0-0
  version: 1.0.0
  label: PCA
  type: data:pca
  category: analyses
  persistence: TEMP
  description: >
    Principal component analysis (PCA)
  input:
    - name: expressions
      label: Expressions
      type: list:data:expression
      required: true
  output:
    - name: pca
      label: PCA
      type: basic:json
  static:
    - name: name
      label: Name
      type: basic:string
      default: PCA
    - name: tags
      label: Tags
      type: list:basic:string
      default: ['PCA', 'plot', 'expressions']
      placeholder: new tag
  run:
    runtime: polyglot
    bash: |
      . {{proc.slugs_path}}/venv-gencloud-0.1/bin/activate

      {% for exp in expressions %}
        if [ {{ exp.output.tpm.file }} ]; then
          exp=$exp"{{ exp.output.tpm.file }},"
        elif [ {{ exp.output.rpkumpolya.file }} ]; then
          exp=$exp"{{ exp.output.rpkumpolya.file }},"
        fi
        obj_id=$obj_id"{{ exp.id }},"
      {% endfor %}

      echo "{\"proc.progress\":0.1, \"proc.rc\":$?}"

      obj_id=${obj_id%?}
      exp=${exp%?}

      echo "{\"proc.progress\":0.2,\"proc.rc\":$?}"

      python -u {{ proc.slugs_path }}/gencloud-20131109/pca.py ${exp} ${obj_id}
      echo "{\"proc.progress\":1.0,\"proc.rc\":$?}"
